name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  validate-build-test:
    name: Validate, Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate schemas
        run: npm run validate:schemas

      - name: Validate catalog
        run: npm run validate:catalog

      - name: Build
        run: npm run build

      - name: Smoke tests
        run: npm run smoke-test

      - name: Generate redirects config
        run: npm run redirects

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  deploy:
    name: Deploy to Coolify
    runs-on: ubuntu-latest
    needs: validate-build-test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
      - name: Trigger Coolify webhook
        run: |
          if [ -n "${{ secrets.COOLIFY_WEBHOOK_URL }}" ]; then
            echo "Triggering Coolify deploy..."
            curl -X POST "${{ secrets.COOLIFY_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              --max-time 30 \
              --retry 3 \
              --retry-delay 5 || true
            echo "Webhook triggered!"
          else
            echo "COOLIFY_WEBHOOK_URL not set, skipping deploy trigger"
          fi

  post-deploy-validation:
    name: Post-Deploy Validation
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for deploy
        run: sleep 120  # Wait 2 minutes for deploy to complete

      - name: Install dependencies
        run: npm ci

      - name: Production smoke tests
        run: npm run smoke-test:prod
        continue-on-error: true  # Don't fail pipeline if prod tests fail
